pipeline {
  agent any
  parameters {
    string(name: 'app', defaultValue: '', description: '')
    string(name: 'revision', defaultValue: '', description: 'Ïù¥Ï†Ñ revision')
    string(name: 'targetRevision', defaultValue: '', description: 'ÌòÑÏû¨ revision')
    string(name: 'repoURL', defaultValue: '', description: 'Git URL')
  }
  stages {
    stage('Git Clone') {
      steps {
        script {
          def username = "devadmin"
          def password = "tkatjdsfmi1!"
          def plainRepo = params.repoURL.replace("https://", "")
          def authenticatedUrl = "https://${username}:${password}@${plainRepo}"

          sh "rm -rf repo"
          sh "git clone ${authenticatedUrl} repo"
        }
      }
    }

    stage('Git Diff') {
      steps {
        dir("repo") {
          script {
            // checkout Ïù¥Ï†Ñ revision
            sh "git checkout ${params.revision}"

            // checkout ÌòÑÏû¨ revision
            sh "git checkout ${params.targetRevision}"

            // Î≥ÄÍ≤ΩÎêú ÌååÏùº Ï∂îÏ∂ú
            def changedFiles = sh(
              script: "git diff ${params.revision} ${params.targetRevision} --name-only",
              returnStdout: true
            ).trim().split("\n")

            echo "Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:"
            changedFiles.each { file ->
              echo " - ${file}"

              if (file.endsWith(".yaml") && file.contains("deployment")) {
                def deploymentYaml = readYaml file: file
                deploymentYaml?.spec?.template?.spec?.containers?.each { container ->
                  echo "Î≥ÄÍ≤ΩÎêú Ïù¥ÎØ∏ÏßÄ: ${container.image}"
                }
              }
            }
          }
        }
      }
    }
  }
}



----

apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  context: |
    argocdUrl: https://argocd.smart-devops.io

  service.webhook.jenkins: |
    url: https://jenkins.smart-devops.io/generic-webhook-trigger/invoke?token=argosync-token
    headers:
      - name: Content-Type
        value: application/json

  template.jenkins-trigger: |
    webhook:
      jenkins:
        method: POST
        body: |
          {
            "app": "{{.app.metadata.name}}",
            "revision": "{{ if .app.status.operationState.syncResult }}{{ .app.status.operationState.syncResult.revision }}{{ end }}",
            "targetRevision": "{{.app.spec.source.targetRevision}}",
            "repoURL": "{{.app.spec.source.repoURL}}"
          }

  trigger.jenkins-sync-success: |
    - name: jenkins-sync-success
      when: app.status.operationState != nil &&
            app.status.operationState.phase == "Succeeded"
      send:
        - jenkins-trigger

  subscriptions: |
    - recipients:
        - jenkins
      triggers:
        - jenkins-sync-success



----

pipeline {
  agent any
  parameters {
    string(name: 'app', defaultValue: '', description: 'ArgoCD App Name')
    string(name: 'revision', defaultValue: '', description: 'ÌòÑÏû¨ revision')
    string(name: 'repoURL', defaultValue: '', description: 'Git Repo URL')
  }
  environment {
    ARGOCD_SERVER = 'argocd.smart-devops.io'
    ARGOCD_TOKEN = credentials('argocd-api-token')
  }
  stages {
    stage('Git Clone') {
      steps {
        script {
          def username = "devadmin"
          def password = "tkatjdsfmi1!"
          def plainRepo = params.repoURL.replace("https://", "")
          def authenticatedUrl = "https://${username}:${password}@${plainRepo}"

          sh "rm -rf repo"
          sh "git clone ${authenticatedUrl} repo"
        }
      }
    }

    stage('Get Previous Revision from ArgoCD') {
      steps {
        script {
          def appName = params.app

          def result = sh(
            script: """
              curl -s -k -H "Authorization: Bearer ${ARGOCD_TOKEN}" \\
              https://${ARGOCD_SERVER}/api/v1/applications/${appName}
            """,
            returnStdout: true
          ).trim()

          def appInfo = readJSON text: result
          def historyList = appInfo?.status?.history

          if (historyList == null || historyList.size() < 2) {
            echo "History insufficient: ÏµúÏ¥à Î∞∞Ìè¨Ïù¥Í±∞ÎÇò Í∏∞Î°ù Î∂ÄÏ°± ‚Üí ÎπåÎìú Ïä§ÌÇµ"
            currentBuild.result = 'NOT_BUILT'
            return
          }

          def previousIndex = historyList.size() - 2
          def previousRevision = historyList[previousIndex].revision
          echo "Ïù¥Ï†Ñ revision: ${previousRevision}"

          dir("repo") {
            sh "git checkout ${params.revision}"
            def changedFiles = sh(
              script: "git diff ${previousRevision} ${params.revision} --name-only",
              returnStdout: true
            ).trim().split("\n")

            if (changedFiles.size() == 0 || changedFiles[0] == '') {
              echo "Î≥ÄÍ≤ΩÎêú ÌååÏùº ÏóÜÏùå ‚Üí ÎπåÎìú Ïä§ÌÇµ"
              currentBuild.result = 'NOT_BUILT'
              return
            }

            echo "Î≥ÄÍ≤ΩÎêú ÌååÏùº:"
            changedFiles.each { file ->
              echo " - ${file}"

              if (file.endsWith(".yaml") && file.contains("deployment")) {
                def deploymentYaml = readYaml file: file
                deploymentYaml?.spec?.template?.spec?.containers?.each { container ->
                  echo "üì¶ Î≥ÄÍ≤ΩÎêú Ïù¥ÎØ∏ÏßÄ: ${container.image}"
                }
              }
            }
          }
        }
      }
    }
  }
}















