import groovy.json.JsonSlurper
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult

// PRì—ì„œ ì»¤ë°‹ ID ì¶”ì¶œ
def commitId = mergeRequest.pullRequest.fromRef.latestCommit
log.warn("ğŸ“Œ PR ëŒ€ìƒ ì»¤ë°‹ ID: ${commitId}")

// Build Status API í˜¸ì¶œ
def url = "https://bitbucket.techartist.xyz/rest/build-status/1.0/commits/${commitId}"
def conn = new URL(url).openConnection()
conn.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
def parsed = new JsonSlurper().parseText(conn.inputStream.text)

// ë¹Œë“œ ìƒíƒœ ë§µ
def statusMap = [:]
def buildKeys = []

// ì‘ë‹µ íŒŒì‹± ë° ìƒíƒœ ìˆ˜ì§‘
if (parsed instanceof Map && parsed.containsKey("values") && parsed["values"] instanceof List) {
    (parsed["values"] as List).each { rawEntry ->
        def entry = rawEntry as Map
        def key = entry["key"]
        def state = entry["state"]

        if (key && state) {
            statusMap[key] = state
            buildKeys << key
            log.warn("ğŸŸ¢ ë¹Œë“œ ìƒíƒœ ìˆ˜ì‹  - ${key} : ${state}")
        }
    }
} else {
    log.warn("âš ï¸ Build Status API ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤: ${parsed.getClass().name}")
}

// ì¡°ê±´ ê²€ì‚¬
def failed = statusMap.findAll { k, v -> v != "SUCCESSFUL" }.keySet()

if (buildKeys.size() < 3) {
    log.warn("âŒ ë“±ë¡ëœ ë¹Œë“œ ìˆ˜ ë¶€ì¡±: ${buildKeys.size()}ê°œ")
    return RepositoryHookResult.rejected("âŒ ë¹Œë“œ ë¶€ì¡±", "ë“±ë¡ëœ ë¹Œë“œ ìˆ˜ê°€ 3ê°œ ë¯¸ë§Œì…ë‹ˆë‹¤.")
}
if (failed) {
    log.warn("âŒ ì‹¤íŒ¨í•œ ë¹Œë“œ: ${failed.join(', ')}")
    log.warn("ğŸ“‹ ì „ì²´ ë¹Œë“œ ìƒíƒœ: ${statusMap}")
    return RepositoryHookResult.rejected("âŒ ë¹Œë“œ ì‹¤íŒ¨", "ì„±ê³µí•˜ì§€ ëª»í•œ ë¹Œë“œ: ${failed.join(', ')}")
}

log.warn("âœ… ëª¨ë“  ë¹Œë“œê°€ ì„±ê³µ ìƒíƒœì´ë©°, ì´ ${buildKeys.size()}ê°œ ë¹Œë“œê°€ ë“±ë¡ë¨")
return RepositoryHookResult.accepted()
