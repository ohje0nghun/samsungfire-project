import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.bitbucket.pull.PullRequest
import com.atlassian.bitbucket.repository.Repository
import com.atlassian.sal.api.component.ComponentLocator
import groovy.json.JsonSlurper

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(mergeRequest.pullRequest.toRef.repository.id, mergeRequest.pullRequest.id)
def latestCommitId = pullRequest.fromRef.latestCommit
def prId = pullRequest.id.toString()

// âœ… í”„ë¡œì íŠ¸ í‚¤ ë° ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (í•˜ë“œì½”ë”© ì œê±°)
def repository = pullRequest.toRef.repository
def projectKey = repository.project.key  // í”„ë¡œì íŠ¸ í‚¤ ë™ì  ì¶”ì¶œ
def repoSlug = repository.slug           // ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ ë™ì  ì¶”ì¶œ

// âœ… QA, Codemind, Changeminer ë¹Œë“œ í‚¤ ë¦¬ìŠ¤íŠ¸ ìƒì„±
def jobNames = ["QA", "codemind", "changeminer"]
def failedJobs = []

if (pullRequest.toRef.displayId == 'develop' && pullRequest.fromRef.displayId.startsWith('feature/')) {
    for (job in jobNames) {
        // ğŸ”¥ í•˜ë“œì½”ë”© ì—†ì´ ë¹Œë“œ í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±
        def buildKey = "${prId}/${projectKey}/${repoSlug}/feature/${pullRequest.fromRef.displayId}/${job}"
        def buildStatus = getBuildStatus(latestCommitId, buildKey)

        // ìƒíƒœê°€ "SUCCESSFUL"ì´ ì•„ë‹ˆë©´ ì‹¤íŒ¨ ëª©ë¡ì— ì¶”ê°€
        if (buildStatus == null || buildStatus in ['FAILED', 'INPROGRESS', 'NOT_BUILT']) {
            failedJobs << job
        }
    }

    // ë§Œì•½ ì‹¤íŒ¨í•œ ë¹Œë“œê°€ ìˆë‹¤ë©´ Mergeë¥¼ ì°¨ë‹¨
    if (failedJobs) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "ë‹¤ìŒ ë¹Œë“œê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${failedJobs.join(', ')}"
        )
    }
}

return RepositoryHookResult.accepted()

// ğŸ” ìµœì‹  ì»¤ë°‹ì˜ ë¹Œë“œ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
String getBuildStatus(String commitId, String buildKey) {
    def bitbucketUrl = "https://bitbucket.smart-devops.io/rest/build-status/1.0/commits/${commitId}"
    def connection = new URL(bitbucketUrl).openConnection()
    connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())

    try {
        def response = connection.inputStream.text
        def jsonResponse = new JsonSlurper().parseText(response)

        if (jsonResponse instanceof Map && jsonResponse.containsKey('values')) {
            def buildEntries = jsonResponse.values
            for (def entry : buildEntries) {
                if (entry['key']?.toString() == buildKey) {
                    return entry['state'] as String
                }
            }
        }
    } catch (Exception e) {
        log.error "ë¹Œë“œ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}"
    }
    return null
}
