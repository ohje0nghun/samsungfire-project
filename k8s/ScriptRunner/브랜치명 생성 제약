*pre-hook
push, branch-create


import com.atlassian.bitbucket.repository.Repository
import com.atlassian.bitbucket.hook.repository.RepositoryHookRequest
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.sal.api.component.ComponentLocator
import com.atlassian.bitbucket.repository.RefService

try {
    def refService = ComponentLocator.getComponent(RefService)
    def request = hookRequest as RepositoryHookRequest
    def newRefs = request.refChanges
    def repo = request.repository

    def slug = repo.slug
    def allowedBranches = []
    def allowedPatterns = []

    // ğŸ“Œ ë ˆí¬ ì´ë¦„ì´ '-pac' ë˜ëŠ” '-config'ë¡œ ëë‚˜ëŠ” ê²½ìš°
    if (slug.endsWith("-pac") || slug.endsWith("-config")) {
        allowedBranches = [
            "refs/heads/dev",
            "refs/heads/sit",
            "refs/heads/uat",
            "refs/heads/prd"
        ]
        // íŒ¨í„´ í—ˆìš© ì—†ìŒ (ëª…í™•í•œ ë¸Œëœì¹˜ë§Œ í—ˆìš©)
    } else {
        allowedBranches = [
            "refs/heads/develop",
            "refs/heads/predevelop",
            "refs/heads/main"
        ]
        allowedPatterns = [
            "refs/heads/feature/.*",
            "refs/heads/release/.*"
        ]
    }

    for (refChange in newRefs) {
        def branchName = refChange.refId

        // íƒœê·¸ëŠ” í—ˆìš©
        if (branchName.startsWith("refs/tags/")) {
            continue
        }

        // ì •í™•íˆ í—ˆìš©ëœ ë¸Œëœì¹˜ëª…ì¸ì§€ í™•ì¸
        if (allowedBranches.contains(branchName)) {
            continue
        }

        // íŒ¨í„´ ê¸°ë°˜ ë¸Œëœì¹˜ í—ˆìš© ì—¬ë¶€ í™•ì¸
        def isValid = allowedPatterns.any { pattern -> branchName.matches(pattern.toString()) }


        if (!isValid) {
            return RepositoryHookResult.rejected(
                "ë¸Œëœì¹˜ ìƒì„± ì œí•œ",
                "ì´ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ í—ˆìš©ë˜ì§€ ì•Šì€ ë¸Œëœì¹˜ëª…ì…ë‹ˆë‹¤. ëª…ëª… ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”."
            )
        }
    }

    return RepositoryHookResult.accepted()

} catch (Exception e) {
    return RepositoryHookResult.accepted()
}
