import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug
def reportKey = "qa-report"

if (fromBranch.startsWith("feature/") && (toBranch == "develop" || toBranch == "predevelop")) {
    def status = getCodeInsightsResult(projectKey, repoSlug, commitId, reportKey)

    if (!"PASS".equalsIgnoreCase(status)) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "Code Insights ë¦¬í¬íŠ¸(${reportKey})ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. í˜„ìž¬ ìƒíƒœ: ${status ?: 'N/A'}"
        )
    }
}

return RepositoryHookResult.accepted()

// === ì •ê·œì‹ ê¸°ë°˜ ë¦¬í¬íŠ¸ ê²°ê³¼ ì¶”ì¶œ ===
String getCodeInsightsResult(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ðŸ” ìž„ì‹œ í…ŒìŠ¤íŠ¸ìš© Basic Auth (ì„œë¹„ìŠ¤ ì ìš© ì‹œ ì™¸ë¶€ ë³´ê´€)
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())

        def responseText = connection.inputStream.text
        def matcher = responseText =~ /"key":"${reportKey}".*?"result":"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}


---
# Codemind, Fortify 2ê°œì— ëŒ€í•œ ë¶€ë¶„
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug

// âœ… ê²€ì‚¬í•  Code Insights ë¦¬í¬íŠ¸ í‚¤
def reportKeys = ["codemind", "fortify"]
def failedReports = []

if (fromBranch.startsWith("feature/") && (toBranch == "develop" || toBranch == "predevelop")) {
    reportKeys.each { reportKey ->
        def status = getCodeInsightsStatus(projectKey, repoSlug, commitId, reportKey)
        if (!"PASS".equalsIgnoreCase(status)) {
            failedReports << "${reportKey} (${status ?: 'N/A'})"
        }
    }

    if (!failedReports.isEmpty()) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤: ${failedReports.join(', ')}"
        )
    }
}

return RepositoryHookResult.accepted()

// === Code Insights ìƒíƒœ ì¡°íšŒ í•¨ìˆ˜ ===
String getCodeInsightsStatus(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
        def response = connection.inputStream.text

        def matcher = response =~ /"key"\s*:\s*"${reportKey}".*?"result"\s*:\s*"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}



