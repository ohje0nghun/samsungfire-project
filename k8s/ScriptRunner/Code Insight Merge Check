import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug
def reportKey = "qa-report"

if (fromBranch.startsWith("feature/") && (toBranch == "develop" || toBranch == "predevelop")) {
    def status = getCodeInsightsResult(projectKey, repoSlug, commitId, reportKey)

    if (!"PASS".equalsIgnoreCase(status)) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "Code Insights ë¦¬í¬íŠ¸(${reportKey})ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: ${status ?: 'N/A'}"
        )
    }
}

return RepositoryHookResult.accepted()

// === ì •ê·œì‹ ê¸°ë°˜ ë¦¬í¬íŠ¸ ê²°ê³¼ ì¶”ì¶œ ===
String getCodeInsightsResult(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ğŸ” ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© Basic Auth (ì„œë¹„ìŠ¤ ì ìš© ì‹œ ì™¸ë¶€ ë³´ê´€)
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())

        def responseText = connection.inputStream.text
        def matcher = responseText =~ /"key":"${reportKey}".*?"result":"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}


---
# Codemind, Fortify 2ê°œì— ëŒ€í•œ ë¶€ë¶„
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug

// âœ… ê²€ì‚¬í•  Code Insights ë¦¬í¬íŠ¸ í‚¤
def reportKeys = ["codemind", "fortify"]
def failedReports = []

if (fromBranch.startsWith("feature/") && (toBranch == "develop" || toBranch == "predevelop")) {
    reportKeys.each { reportKey ->
        def status = getCodeInsightsStatus(projectKey, repoSlug, commitId, reportKey)
        if (!"PASS".equalsIgnoreCase(status)) {
            failedReports << "${reportKey} (${status ?: 'N/A'})"
        }
    }

    if (!failedReports.isEmpty()) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤: ${failedReports.join(', ')}"
        )
    }
}

return RepositoryHookResult.accepted()

// === Code Insights ìƒíƒœ ì¡°íšŒ í•¨ìˆ˜ ===
String getCodeInsightsStatus(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
        def response = connection.inputStream.text

        def matcher = response =~ /"key"\s*:\s*"${reportKey}".*?"result"\s*:\s*"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}



---
ë¶„ê¸°ì²˜ë¦¬ ëœê±°
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug

// âœ… 2. ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ì´ '-config'ë¡œ ëë‚˜ë©´ ê²€ì‚¬ ì•ˆ í•¨
if (repoSlug.endsWith("-config")) {
    return RepositoryHookResult.accepted()
}

// âœ… 1. ëª©ì  ë¸Œëœì¹˜ê°€ 'develop'ì´ ì•„ë‹ ê²½ìš° ê²€ì‚¬ ì•ˆ í•¨
if (!toBranch.equalsIgnoreCase("develop")) {
    return RepositoryHookResult.accepted()
}

// âœ… ê²€ì‚¬í•  Code Insights ë¦¬í¬íŠ¸ í‚¤
def reportKeys = ["codemind", "fortify"]
def failedReports = []

// ê²€ì‚¬ ì‹¤í–‰
reportKeys.each { reportKey ->
    def status = getCodeInsightsStatus(projectKey, repoSlug, commitId, reportKey)
    if (!"PASS".equalsIgnoreCase(status)) {
        failedReports << "${reportKey} (${status ?: 'N/A'})"
    }
}

// ê²€ì‚¬ ì‹¤íŒ¨í•œ ë¦¬í¬íŠ¸ê°€ ìˆì„ ê²½ìš° Merge ì°¨ë‹¨
if (!failedReports.isEmpty()) {
    return RepositoryHookResult.rejected(
        "Merge Check Failed",
        "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤: ${failedReports.join(', ')}"
    )
}

return RepositoryHookResult.accepted()

// === Code Insights ìƒíƒœ ì¡°íšŒ í•¨ìˆ˜ ===
String getCodeInsightsStatus(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ğŸ” ì¸ì¦ì€ ë‚˜ì¤‘ì— ì™¸ë¶€ ê´€ë¦¬ ì¶”ì²œ
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
        def response = connection.inputStream.text

        def matcher = response =~ /"key"\s*:\s*"${reportKey}".*?"result"\s*:\s*"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}



--- 
// DEV ë§Œ REPORT ì¡´ì¬í•´ì•¼  MERGE

// PR ë³‘í•©ì„ ì œì–´í•˜ê¸° ìœ„í•œ Hook ê²°ê³¼ íƒ€ì…
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult

// Pull Request ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” Bitbucket ì„œë¹„ìŠ¤
import com.atlassian.bitbucket.pull.PullRequestService

// ScriptRunnerì—ì„œ Bitbucketì˜ ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìœ í‹¸
import com.atlassian.sal.api.component.ComponentLocator

// ğŸ”¹ PullRequestService ì¸ìŠ¤í„´ìŠ¤ ì–»ê¸°
PullRequestService pullRequestService = ComponentLocator.getComponent(PullRequestService)

// ğŸ”¹ í˜„ì¬ ë³‘í•© ì‹œë„ ì¤‘ì¸ PR ê°ì²´ë¥¼ PR IDë¥¼ í†µí•´ ê°€ì ¸ì˜´
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id, // PR ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬ ID
    mergeRequest.pullRequest.id                   // PR ID
)

// ğŸ”¹ PR ê´€ë ¨ ì •ë³´ ì¶”ì¶œ
String toBranch = pullRequest.toRef.displayId                   // ëª©ì  ë¸Œëœì¹˜ëª… (ì˜ˆ: "dev")
String commitId = pullRequest.fromRef.latestCommit              // PRì˜ source ë¸Œëœì¹˜ ìµœì‹  ì»¤ë°‹ SHA
String projectKey = pullRequest.toRef.repository.project.key    // í”„ë¡œì íŠ¸ í‚¤ (ì˜ˆ: "PJ1234")
String repoSlug = pullRequest.toRef.repository.slug             // ë ˆí¬ ìŠ¬ëŸ¬ê·¸ (ì˜ˆ: "my-repo")

// âœ… ê²€ì‚¬ ì¡°ê±´: ëª©ì  ë¸Œëœì¹˜ê°€ "dev"ì¼ ë•Œë§Œ ê²€ì‚¬ ìˆ˜í–‰
if (!toBranch.equalsIgnoreCase("dev")) {
    return RepositoryHookResult.accepted() // devê°€ ì•„ë‹ˆë©´ ê²€ì‚¬í•˜ì§€ ì•Šê³  í†µê³¼
}

// âœ… ê²€ì‚¬í•´ì•¼ í•  í•„ìˆ˜ Code Insights Report í‚¤ ëª©ë¡
List<String> requiredReports = ["codemind", "fortify"] // í•„ìˆ˜ ë¦¬í¬íŠ¸ í‚¤
List<String> foundReports = []                         // ì‹¤ì œ ë°œê²¬ëœ ë¦¬í¬íŠ¸ í‚¤ ì €ì¥ìš©

// ğŸ” í˜„ì¬ ì»¤ë°‹ì— ë“±ë¡ëœ ëª¨ë“  Code Insights ë¦¬í¬íŠ¸ í‚¤ ì¡°íšŒ
List<String> allReports = getAllReportKeys(projectKey, repoSlug, commitId)

// í•„ìˆ˜ ë¦¬í¬íŠ¸ ëª©ë¡ì„ ìˆœíšŒí•˜ë©° ì‹¤ì œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
requiredReports.each { String key ->
    if (allReports.contains(key)) {
        foundReports << key // ì¡´ì¬í•˜ëŠ” í‚¤ëŠ” ê¸°ë¡
    }
}

// âŒ í•˜ë‚˜ë¼ë„ ëˆ„ë½ëœ ë¦¬í¬íŠ¸ê°€ ìˆì„ ê²½ìš° ë³‘í•© ì°¨ë‹¨
if (foundReports.size() < requiredReports.size()) {
    List<String> missing = requiredReports - foundReports
    return RepositoryHookResult.rejected(
        "Code Insights Report ëˆ„ë½", // Bitbucket UIì— í‘œì‹œë  ë©”ì‹œì§€ ì œëª©
        "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${missing.join(', ')}" // ìƒì„¸ ë©”ì‹œì§€
    )
}

// âœ… í•„ìˆ˜ ë¦¬í¬íŠ¸ê°€ ëª¨ë‘ ì¡´ì¬í•˜ë©´ ë³‘í•© í—ˆìš©
return RepositoryHookResult.accepted()

// =============================================
// ğŸ” í˜„ì¬ ì»¤ë°‹ì— ì¡´ì¬í•˜ëŠ” Code Insights ë¦¬í¬íŠ¸ í‚¤ ëª©ë¡ ì¡°íšŒ í•¨ìˆ˜
// =============================================
List<String> getAllReportKeys(String projectKey, String repoSlug, String commitId) {
    try {
        // Bitbucketì˜ Code Insights REST API í˜¸ì¶œ URL êµ¬ì„±
        String url = "http://bitbucket.techartist.xyz/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ì¸ì¦ í—¤ë” ì„¤ì • (ê¸°ë³¸ ì¸ì¦ ë°©ì‹, Base64 ì¸ì½”ë”©ëœ ì‚¬ìš©ìì •ë³´)
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())

        // ì‘ë‹µ ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ì½ìŒ
        String response = connection.inputStream.text

        // ì •ê·œì‹ìœ¼ë¡œ ì‘ë‹µ ë‚´ `"key": "ë¦¬í¬íŠ¸ëª…"` í˜•íƒœë§Œ ì¶”ì¶œ
        def matcher = response =~ /"key"\s*:\s*"([^"]+)"/
        List<String> reportKeys = []

        // ë°˜ë³µí•˜ë©° key ê°’ ìˆ˜ì§‘
        while (matcher.find()) {
            reportKeys << matcher.group(1)
        }

        return reportKeys // ë¦¬í¬íŠ¸ í‚¤ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    } catch (Exception e) {
        return [] // ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ (ë¨¸ì§€ ì°¨ë‹¨ ìª½ì—ì„œ íŒë‹¨)
    }
}









