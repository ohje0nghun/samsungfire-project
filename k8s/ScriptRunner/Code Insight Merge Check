import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug
def reportKey = "qa-report"

if (fromBranch.startsWith("feature/") && (toBranch == "develop" || toBranch == "predevelop")) {
    def status = getCodeInsightsResult(projectKey, repoSlug, commitId, reportKey)

    if (!"PASS".equalsIgnoreCase(status)) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "Code Insights ë¦¬í¬íŠ¸(${reportKey})ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: ${status ?: 'N/A'}"
        )
    }
}

return RepositoryHookResult.accepted()

// === ì •ê·œì‹ ê¸°ë°˜ ë¦¬í¬íŠ¸ ê²°ê³¼ ì¶”ì¶œ ===
String getCodeInsightsResult(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ğŸ” ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© Basic Auth (ì„œë¹„ìŠ¤ ì ìš© ì‹œ ì™¸ë¶€ ë³´ê´€)
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())

        def responseText = connection.inputStream.text
        def matcher = responseText =~ /"key":"${reportKey}".*?"result":"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}


---
# Codemind, Fortify 2ê°œì— ëŒ€í•œ ë¶€ë¶„
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug

// âœ… ê²€ì‚¬í•  Code Insights ë¦¬í¬íŠ¸ í‚¤
def reportKeys = ["codemind", "fortify"]
def failedReports = []

if (fromBranch.startsWith("feature/") && (toBranch == "develop" || toBranch == "predevelop")) {
    reportKeys.each { reportKey ->
        def status = getCodeInsightsStatus(projectKey, repoSlug, commitId, reportKey)
        if (!"PASS".equalsIgnoreCase(status)) {
            failedReports << "${reportKey} (${status ?: 'N/A'})"
        }
    }

    if (!failedReports.isEmpty()) {
        return RepositoryHookResult.rejected(
            "Merge Check Failed",
            "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤: ${failedReports.join(', ')}"
        )
    }
}

return RepositoryHookResult.accepted()

// === Code Insights ìƒíƒœ ì¡°íšŒ í•¨ìˆ˜ ===
String getCodeInsightsStatus(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
        def response = connection.inputStream.text

        def matcher = response =~ /"key"\s*:\s*"${reportKey}".*?"result"\s*:\s*"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}



---
ë¶„ê¸°ì²˜ë¦¬ ëœê±°
import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

def pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

def fromBranch = pullRequest.fromRef.displayId
def toBranch = pullRequest.toRef.displayId
def commitId = pullRequest.fromRef.latestCommit
def projectKey = pullRequest.toRef.repository.project.key
def repoSlug = pullRequest.toRef.repository.slug

// âœ… 2. ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ì´ '-config'ë¡œ ëë‚˜ë©´ ê²€ì‚¬ ì•ˆ í•¨
if (repoSlug.endsWith("-config")) {
    return RepositoryHookResult.accepted()
}

// âœ… 1. ëª©ì  ë¸Œëœì¹˜ê°€ 'develop'ì´ ì•„ë‹ ê²½ìš° ê²€ì‚¬ ì•ˆ í•¨
if (!toBranch.equalsIgnoreCase("develop")) {
    return RepositoryHookResult.accepted()
}

// âœ… ê²€ì‚¬í•  Code Insights ë¦¬í¬íŠ¸ í‚¤
def reportKeys = ["codemind", "fortify"]
def failedReports = []

// ê²€ì‚¬ ì‹¤í–‰
reportKeys.each { reportKey ->
    def status = getCodeInsightsStatus(projectKey, repoSlug, commitId, reportKey)
    if (!"PASS".equalsIgnoreCase(status)) {
        failedReports << "${reportKey} (${status ?: 'N/A'})"
    }
}

// ê²€ì‚¬ ì‹¤íŒ¨í•œ ë¦¬í¬íŠ¸ê°€ ìˆì„ ê²½ìš° Merge ì°¨ë‹¨
if (!failedReports.isEmpty()) {
    return RepositoryHookResult.rejected(
        "Merge Check Failed",
        "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ PASS ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤: ${failedReports.join(', ')}"
    )
}

return RepositoryHookResult.accepted()

// === Code Insights ìƒíƒœ ì¡°íšŒ í•¨ìˆ˜ ===
String getCodeInsightsStatus(String projectKey, String repoSlug, String commitId, String reportKey) {
    try {
        def url = "https://bitbucket.smart-devops.io/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ğŸ” ì¸ì¦ì€ ë‚˜ì¤‘ì— ì™¸ë¶€ ê´€ë¦¬ ì¶”ì²œ
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
        def response = connection.inputStream.text

        def matcher = response =~ /"key"\s*:\s*"${reportKey}".*?"result"\s*:\s*"(\w+)"/
        if (matcher.find()) {
            return matcher.group(1)
        }
    } catch (Exception ignored) {
        return null
    }
    return null
}



--- 
// DEV ë§Œ REPORT ì¡´ì¬í•´ì•¼  MERGE

import com.atlassian.bitbucket.hook.repository.RepositoryHookResult
import com.atlassian.bitbucket.pull.PullRequestService
import com.atlassian.sal.api.component.ComponentLocator

// ğŸ”¹ PR ì •ë³´ ì¡°íšŒ
PullRequestService pullRequestService = ComponentLocator.getComponent(PullRequestService)
def pullRequest = pullRequestService.getById(
    mergeRequest.pullRequest.toRef.repository.id,
    mergeRequest.pullRequest.id
)

String toBranch = pullRequest.toRef.displayId
String commitId = pullRequest.fromRef.latestCommit
String projectKey = pullRequest.toRef.repository.project.key
String repoSlug = pullRequest.toRef.repository.slug

// âœ… dev ë¸Œëœì¹˜ ëŒ€ìƒ PRë§Œ ê²€ì‚¬
if (!toBranch.equalsIgnoreCase("dev")) {
    return RepositoryHookResult.accepted()
}

// âœ… ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•  Code Insights ë¦¬í¬íŠ¸ í‚¤ ëª©ë¡
List<String> requiredReports = ["codemind", "fortify"]
List<String> foundReports = []

// ğŸ“Œ í˜„ì¬ ì»¤ë°‹ì— ë“±ë¡ëœ ì „ì²´ ë¦¬í¬íŠ¸ í‚¤ ëª©ë¡ ì¡°íšŒ
List<String> allReports = getAllReportKeys(projectKey, repoSlug, commitId)

requiredReports.each { String key ->
    if (allReports.contains(key)) {
        foundReports << key
    }
}

// âŒ ì¼ë¶€ ë¦¬í¬íŠ¸ê°€ ëˆ„ë½ëœ ê²½ìš° ë³‘í•© ì°¨ë‹¨
if (foundReports.size() < requiredReports.size()) {
    List<String> missing = requiredReports - foundReports
    return RepositoryHookResult.rejected(
        "Code Insights Report ëˆ„ë½",
        "ë‹¤ìŒ ë¦¬í¬íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${missing.join(', ')}"
    )
}

// âœ… ë¦¬í¬íŠ¸ê°€ ëª¨ë‘ ì¡´ì¬í•˜ë©´ ë³‘í•© í—ˆìš©
return RepositoryHookResult.accepted()

// ==============================
// ğŸ” Code Insights Report ëª©ë¡ ì¡°íšŒ
// ==============================
List<String> getAllReportKeys(String projectKey, String repoSlug, String commitId) {
    try {
        String url = "http://bitbucket.techartist.xyz/rest/insights/1.0/projects/${projectKey}/repos/${repoSlug}/commits/${commitId}/reports"
        def connection = new URL(url).openConnection()

        // ì¸ì¦ ì •ë³´ëŠ” ScriptRunner í™˜ê²½ ë³€ìˆ˜ë¡œ ì¶”ì¶œ ê¶Œì¥
        connection.setRequestProperty("Authorization", "Basic " + "devadmin:tkatjdsfmi1!".bytes.encodeBase64().toString())
        String response = connection.inputStream.text

        // ì •ê·œì‹ìœ¼ë¡œ "key": "xxx" ê°’ë§Œ ì¶”ì¶œ
        def matcher = response =~ /"key"\s*:\s*"([^"]+)"/
        List<String> reportKeys = []
        while (matcher.find()) {
            reportKeys << matcher.group(1)
        }
        return reportKeys
    } catch (Exception e) {
        return []
    }
}








